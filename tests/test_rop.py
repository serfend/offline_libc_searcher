import platform
import sgtlibc.ROPgadgets
import pytest
from .common import get_elf_resources


@pytest.mark.skipif(platform.uname()[0] == 'Windows', reason='skip windows')
@pytest.mark.skipif(platform.uname()[0] == 'Darwin', reason='skip mac')
def test_rop_get():
    path = get_elf_resources('pwn1')
    elf = sgtlibc.ROPgadgets.ELF(path)
    data = elf.get_rop()

    assert 'ret' in data and data['ret'] == 0x4005d9
    assert 'rdi' in data and data['rdi'] == 0x400a03


def test_rop_gadgets_csu():
    data = sgtlibc.ROPgadgets.gadget_by_csu(0x1234, 0x1, 0, 0, 0, 0x4321)
    assert b'&\x12\x00\x00\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x12\x00\x00\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00\xef\xbe\xad\xde\x00\x00\x00\x00!C\x00\x00\x00\x00\x00\x00' == data
